name: Azure Container Apps Blue-Green Deployment

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  AZURE_CLIENT_ID: ${{ vars.AZURE_CLIENT_ID }}
  AZURE_TENANT_ID: ${{ vars.AZURE_TENANT_ID }}
  AZURE_SUBSCRIPTION_ID: ${{ vars.AZURE_SUBSCRIPTION_ID }}
  AZURE_ENV_NAME: ${{ vars.AZURE_ENV_NAME }}
  AZURE_LOCATION: ${{ vars.AZURE_LOCATION }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install azd
      uses: Azure/setup-azd@v2
      with:
        version: 1.21.1

    - name: Log in with Azure (Federated Credentials)
      if: ${{ env.AZURE_CLIENT_ID != '' }}
      run: |
        azd auth login \
          --client-id "${{ env.AZURE_CLIENT_ID }}" \
          --federated-credential-provider "github" \
          --tenant-id "${{ env.AZURE_TENANT_ID }}"
      shell: bash

    - name: Restore azd environment
      run: |
        azd env refresh ${{ env.AZURE_ENV_NAME }} --no-prompt
        azd env set AZURE_LOCATION ${{ env.AZURE_LOCATION }} --no-prompt
        
        echo "üìã Values after azd env refresh:"
        ENV_VALUES=$(azd env get-values 2>&1 | grep -v "WARNING:" | grep -v "To update" | grep -v "curl -fsSL")
        echo "$ENV_VALUES" | grep -E "COMMIT_ID|PRODUCTION_LABEL" || echo "No commit/label values found"
      shell: bash

    - name: Get current commit ID
      id: commit
      run: echo "commit_id=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT

    - name: Determine deployment target
      id: params
      run: |
        # Login to query Container App tags
        az login --service-principal \
          -u ${{ vars.AZURE_CLIENT_ID }} \
          -t ${{ vars.AZURE_TENANT_ID }} \
          --federated-token $(curl -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=api://AzureADTokenExchange" | jq -r .value)
        az account set --subscription ${{ vars.AZURE_SUBSCRIPTION_ID }}
        
        RG_NAME="rg-${{ env.AZURE_ENV_NAME }}"
        TAGS=$(az containerapp show -g $RG_NAME -n web --query tags -o json)
        
        # Read current state from tags
        BLUE_COMMIT=$(echo $TAGS | jq -r '.blueCommitId // ""')
        GREEN_COMMIT=$(echo $TAGS | jq -r '.greenCommitId // ""')
        CURRENT_PROD_LABEL=$(echo $TAGS | jq -r '.productionLabel // ""')
        
        echo "üìã Current state:"
        echo "  Blue: ${BLUE_COMMIT:-none}"
        echo "  Green: ${GREEN_COMMIT:-none}"
        echo "  Production: ${CURRENT_PROD_LABEL:-none}"
        
        # Restore to azd environment
        [ -n "$BLUE_COMMIT" ] && azd env set BLUE_COMMIT_ID $BLUE_COMMIT --no-prompt
        [ -n "$GREEN_COMMIT" ] && azd env set GREEN_COMMIT_ID $GREEN_COMMIT --no-prompt
        [ -n "$CURRENT_PROD_LABEL" ] && azd env set PRODUCTION_LABEL $CURRENT_PROD_LABEL --no-prompt
        
        # Deploy to opposite of current production
        if [ "$CURRENT_PROD_LABEL" == "green" ]; then
          echo "new_prod_label=blue" >> $GITHUB_OUTPUT
          echo "cur_prod_label=green" >> $GITHUB_OUTPUT
        else
          echo "new_prod_label=green" >> $GITHUB_OUTPUT
          echo "cur_prod_label=${CURRENT_PROD_LABEL:-blue}" >> $GITHUB_OUTPUT
        fi
        
        echo "üéØ Deploying to: ${{ steps.params.outputs.new_prod_label }}"
      shell: bash

    - name: Configure deployment variables
      run: |
        if [ "${{ steps.params.outputs.new_prod_label }}" == "blue" ]; then
          azd env set BLUE_COMMIT_ID ${{ steps.commit.outputs.commit_id }} --no-prompt
        else
          azd env set GREEN_COMMIT_ID ${{ steps.commit.outputs.commit_id }} --no-prompt
        fi
        azd env set LATEST_COMMIT_ID ${{ steps.commit.outputs.commit_id }} --no-prompt
      shell: bash

    - name: Deploy to non-production label
      run: azd deploy --all --no-prompt
      shell: bash

    - name: Test non-production label
      run: |
        ENV_VALUES=$(azd env get-values 2>&1 | grep -v "WARNING:" | grep -v "To update" | grep -v "curl -fsSL")
        SERVICE_URI=$(echo "$ENV_VALUES" | grep "^SERVICE_WEB_URI=" | cut -d'=' -f2 | tr -d '"')
        DOMAIN=$(echo $SERVICE_URI | sed 's|https://||' | cut -d'.' -f2-)
        TEST_URL="https://web---${{ steps.params.outputs.new_prod_label }}.$DOMAIN"
        
        echo "Testing: $TEST_URL"
        HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" $TEST_URL)
        
        if [[ $HTTP_STATUS == "200" ]]; then
          echo "‚úÖ Test passed (HTTP $HTTP_STATUS)"
        else
          echo "‚ùå Test failed (HTTP $HTTP_STATUS)"
          exit 1
        fi
      shell: bash

    - name: Switch production traffic
      run: |
        azd env set PRODUCTION_LABEL ${{ steps.params.outputs.new_prod_label }} --no-prompt
        azd deploy web --no-prompt
        echo "‚úÖ Production switched to ${{ steps.params.outputs.new_prod_label }}"
      shell: bash

    - name: Verify production
      run: |
        ENV_VALUES=$(azd env get-values 2>&1 | grep -v "WARNING:" | grep -v "To update" | grep -v "curl -fsSL")
        SERVICE_URI=$(echo "$ENV_VALUES" | grep "^SERVICE_WEB_URI=" | cut -d'=' -f2 | tr -d '"')
        HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" $SERVICE_URI)
        
        echo "Production URL: $SERVICE_URI"
        if [[ $HTTP_STATUS == "200" ]]; then
          echo "‚úÖ Production healthy (HTTP $HTTP_STATUS)"
        else
          echo "‚ö†Ô∏è Warning: HTTP $HTTP_STATUS"
        fi
      shell: bash
